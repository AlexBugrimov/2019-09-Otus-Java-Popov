<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Админка</title>

<!--   not working <script src="/webjars/sockjs-client/sockjs.min.js"></script>-->
<!--    <script src="/webjars/stomp-websocket/stomp.min.js"></script>-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
    <script>
        const stompClient = Stomp.over(new SockJS('/app/websocket'));

        function subscribeOnLoadAllUsers() {
          stompClient.connect({}, (frame) => {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/allUsers', (msg) => {
                const users = JSON.parse(msg.body);
                console.log(users);
                let tableBody = usersTable.getElementsByTagName('tbody')[0];
                let rows = '';
                users.forEach((user, idx) => {
                    rows += '<tr>' + '<td>' + user.id + '</td>'
                     + '<td>' + user.name + '</td>'
                      + '<td>' + user.login + '</td>'
                      + '<td>' + user.password + '</td>' + '</tr>';
                });
                tableBody.innerHTML = rows;
            });
          });
        }

        function sendLoadAllUsersRequest() {
            stompClient.send("/app/getAllUsers", {}, {});
        }

        function createNewUser(form) {
            stompClient.send("/app/createUser", {}, extractUserJson(form));

            /*fetch('api/user/', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                  },
                  body: extractUserJson(form)
                }).then(res => {
                    if (res.status >= 500) {
                        alert('Ошибка при создании пользователя');
                        console.log(res);
                    } else {
                        loadAllUsers();
                    }
                })
                  .catch(res => {
                    alert('Ошибка');
                    console.log(res)
                  });*/
        }

        function extractUserJson(form) {
            let userObj = objectFromForm(form);
            userObj['isAdmin'] = userObj['isAdmin'] === 'on' ? true : false;
            return JSON.stringify(userObj);
        }

        function objectFromForm(form) {
            let object = {};
            let formData = new FormData(form);
            formData.forEach((value, key) => {object[key] = value});

            return object;
        }
    </script>
</head>

<body onload="subscribeOnLoadAllUsers();">
<a href="logout">Выйти</a>
<br/>
<h1>Создание нового пользователя:</h1>
<form onsubmit="createNewUser(this); return false;" action="#" autocomplete="off">
    <label>
        Имя <br/>
        <input type="text" name="name">
    </label>
    <br/>
    <label>
        Логин <br/>
        <input type="text" name="login">
    </label>
    <br/>
    <label>
        Пароль <br/>
        <input type="password" name="password">
    </label>
    <br/>
    <label>
        Админ <br/>
        <input type="checkbox" name="isAdmin">
    </label>
    <br/>
    <br/>
    <input type="submit" value="Создать">
</form>

<h1>Список всех пользователей:</h1>
<button onclick="sendLoadAllUsersRequest()" style="margin: 0 0 10px 0;">Загрузить список пользователей</button>
<table id="usersTable" style="width: 400px; border: solid 1px;">
    <thead>
        <tr>
            <td style="width: 50px">Id</td>
            <td style="width: 150px">Имя</td>
            <td style="width: 100px">Логин</td>
            <td style="width: 100px">Пароль</td>
        </tr>
    </thead>
    <tbody>
        <!-- content will be changed on button click -->
    </tbody>
</table>
</body>
</html>
